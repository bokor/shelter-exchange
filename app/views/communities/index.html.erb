<%= title "Community" %>

<%= content_for :javascripts do %>
	<%= javascript_include_tag "http://maps.google.com/maps/api/js?sensor=false", "shelters/shelters", "maps/maps", :cache => "cache/application/communities-index" %>
	<!-- "jquery.googlemaps.min" -->
	<script type="text/javascript">
		$(function() {
			var defaultZoom = 11;
			var geocoder = new google.maps.Geocoder();
			var myLatlng = new google.maps.LatLng(<%=@current_shelter.lat%>,<%=@current_shelter.lng%>);
			var myOptions = {
		    	zoom: defaultZoom,
			    center: myLatlng,
			    mapTypeId: google.maps.MapTypeId.ROADMAP
			}
			var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		
			var fileUrl = 'http://www.designwaves.com/shelters.kmz'; //?<%=Time.new.to_i%>
			var kmlLayer = new google.maps.KmlLayer(fileUrl, { preserveViewport: true });
			kmlLayer.setMap(map);
			
			// Add Listener for City/Zipcode Searching and Map Movement
			google.maps.event.addListener(map, 'idle', function(){
				findAnimalsInBounds(map);
			});
			
			//MOVE INTO MAPS.js
			function geocodeAddress(e){
				geocoder.geocode( { address: $("#address").val() }, function(results, status) {
			     	if (status == google.maps.GeocoderStatus.OK) {
			        	map.setCenter(results[0].geometry.location);
			      	} else {
			        	alert("Geocode was not successful for the following reason: " + status);
			      	}
			    });
			}
			//MOVE INTO MAPS.js
			function findAnimalsInBounds(map){
				var zoomLevel = map.getZoom();
				if (zoomLevel < 10) {
					$('#all_animals').html( "<h2>Please zoom in to search for animals</h2>" );
					$('#urgent_needs_animals').html( "<h2>Please zoom in to search for animals</h2>" );
				} else {
					var bounds = map.getBounds();
					var sw = bounds.getSouthWest().toUrlValue();
					var ne = bounds.getNorthEast().toUrlValue();
					$.get("/maps/find_animals_in_bounds.js", { sw: sw, ne: ne });
				}
			
			}
			//MOVE INTO MAPS.js
			function findAnimalsForShelter(map){
				var zoomLevel = map.getZoom();
				if (zoomLevel < 10) {
					$('#all_animals').html( "<h2>Please zoom in to search for animals</h2>" );
					$('#urgent_needs_animals').html( "<h2>Please zoom in to search for animals</h2>" );
				} else {
					var shelterName = $('#shelter_name').val();
					$.get("/maps/find_animals_for_shelter.js", { shelter_name: shelterName });
				}
			}
			
			
			
			$("#form_address_search").bind("submit", function(e){
				geocodeAddress(e);
				map.setZoom(defaultZoom);
				e.preventDefault();
				
			});
			
			$("#form_shelter_name_search").bind("submit", function(e){
				findAnimalsForShelter(map);
				e.preventDefault();
			});
	

			$("#breed_search").click(function(){
				$("#breed_search").autocomplete( "search", "" );
			});
			
			$("#breed_search").autocomplete({
				minLength: 0,
				selectFirst: true,
				html: true,
				delay: 500,
				source: function( request, response ) {
					$.ajax({
						url: "/breeds/auto_complete.json",
						dataType: "json",
						data: {
							q: request.term,
							animal_type_id: 1
						},
						success: function( data ) {
							response( $.map( data, function( item ) {
								var terms = request.term.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi, "\\$1");
								var matcher = new RegExp("(?![^&;]+;)(?!<[^<>]*)(" + terms + ")(?![^<>]*>)(?![^&;]+;)", "gi");
								return {
									label: item.name.replace(matcher,'<strong>$1</strong>'),
									value: item.name,
									id: item.id
								}  
							}));
						}
					});
				}			
			});
			
			
			
		});
	</script>
<% end %>

<%= content_for :page_content do %>

	<!-- <div class="page_heading green_background">
		<h1>Community</h1>
	</div> -->
		
	<div class="page_content">
		
		<div>
			<h2>Search By:</h2>
			<div style="float: left; width: 50%;">
				<form action="#" id="form_address_search">
					<ul class="form">
						<li>
							<%= label_tag :address, "City/Zipcode" %><br />
							<%= text_field_tag :address, @current_shelter.zip_code, :style => "width: 90%;"  %> <%= submit_tag "Go" %>
						</li>
					</ul>
				</form>
			</div>
			<div style="float: left; width: 50%;">
				<form action="#" id="form_shelter_name_search">
					<ul class="form">
						<li style="width: 90%;">
						<%= label_tag :shelter_name, "Shelter name" %><br />
						<%= text_field_tag :shelter_name, "", :autocomplete => :off, :style => "width: 90%;"  %> <%= submit_tag "Go" %>
						</li>
					</ul>
				</form>
			</div>
		</div>
		
		<div style="width: 100%;" class="results">
			<div id="map_canvas" style="width:100%; height: 450px;"></div>
		
		</div>
		<div class="clear"></div>
		
		<div class="separator"></div>
		<a href="#" onclick="$('#filters').slideToggle();return false;">Narrow your search results</a>
		<div id="filters" style="display:none;padding-top: 10px;">
			<h2>Filter by:</h2>
			
			<%= label_tag :animal_animal_type_id, "Animal type" %><br />
			<%= collection_select :type, :type, AnimalType.all, :id, :name, :prompt => "Select Type" %><br /><br />
			<%= label_tag :breed_search, "Breed" %><br />
			<%= text_field_tag :breed_search, "",:autocomplete => :off %><br /><br />
			<%= label_tag :sex, "Sex" %><br />
			<%= collection_select :sex, :sex, SEX, :to_s, :humanize, :prompt => "Select one" %><br /><br />
			<%= label_tag :status, "Status" %><br />
			<%= collection_select :status, :status, AnimalStatus.active.all, :id, :name, :prompt => "Select one" %><br /><br />
			<%= label_tag :microchip, "Microchip" %><br />
			<%= text_field_tag :microchip, "",:autocomplete => :off %><br /><br />
		</div>
		<div class="separator"></div>
		<div style="width: 100%;">
			<div style="float:left; width:45%; padding-right: 2%; border-right: 1px dotted #ccc;">
				<h2>Animals</h2>
				<div id="all_animals"></div>
			</div>
			<div style="float:left; width:50%;padding-left: 3%;">
				<h2>Urgent Needs</h2>
				<div id="urgent_needs_animals"></div>
			</div>
		</div>
		<div class="clear"></div>
		
	</div>
		
<% end %>

<%= content_for :sidebar do %>
<% end %>